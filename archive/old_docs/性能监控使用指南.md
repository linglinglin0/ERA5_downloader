# ERA5下载性能监控器 - 使用指南

## 功能特性

### 核心功能

1. **实时速度监控**
   - 动态折线图展示下载速度
   - 支持多时间范围查看（10分钟/30分钟/1小时/2小时/全部）
   - 自动时间轴格式化（年月日 时分秒）

2. **累计下载量监控**
   - 绿色折线图展示总下载量
   - GB单位显示
   - 增长趋势可视化

3. **系统资源监控**
   - CPU使用率（红色曲线）
   - 内存使用率（黄色曲线）
   - 活跃S3连接数（青色曲线）
   - 三维度资源占用分析

4. **数据持久化**
   - SQLite数据库存储
   - 完整历史记录
   - 支持离线分析

5. **统计分析**
   - 平均/最高/最低速度
   - 总下载量统计
   - 运行时长统计
   - 网络错误计数

6. **数据导出**
   - CSV格式导出
   - 支持Excel分析
   - 包含完整时间戳

---

## 快速开始

### 方法1：使用启动脚本（推荐）

```bash
启动性能监控.bat
```

### 方法2：命令行启动

```bash
uv run era5_performance_monitor.py
```

---

## 使用步骤

### 第一步：配置监控目录

1. 启动程序后，点击左侧 **"浏览..."** 按钮
2. 选择ERA5下载目录
   - 例如：`D:\wzl\ERA5下载软件\data\202510`

**重要：** 监控目录应该是包含 `.nc` 文件的日期目录

### 第二步：设置更新参数

**更新间隔：**
- 默认：2秒
- 可调范围：1-10秒
- 建议：2-5秒（平衡性能和精度）

**显示时间范围：**
- 10分钟 - 查看短期波动
- 30分钟 - 查看中期趋势
- 60分钟 - 查看长期趋势
- 120分钟 - 查看超长期
- 全部 - 查看所有历史数据

### 第三步：开始监控

1. 点击 **"开始监控"** 按钮
2. 图表开始实时更新
3. 查看不同Tab的监控数据

### 第四步：查看分析

切换到 **"统计分析"** 标签页，查看：
- 监控时长
- 开始/结束时间
- 总下载量
- 平均/最高/最低速度

### 第五步：导出数据（可选）

点击 **"导出数据"** 按钮，保存为CSV文件供进一步分析。

---

## 图表说明

### Tab 1: 下载速度

```
Y轴：速度（MB/s）
X轴：时间（时分秒）

蓝色曲线：实时下载速度
```

**分析要点：**
- 速度平稳 → 连接健康
- 速度下降 → 可能限流或网络问题
- 速度波动 → 网络不稳定
- 速度归零 → 下载完成或中断

### Tab 2: 累计下载量

```
Y轴：下载量（GB）
X轴：时间（时分秒）

绿色曲线：累计下载量增长
```

**分析要点：**
- 线性增长 → 速度稳定
- 斜率变缓 → 速度下降
- 斜率增加 → 速度提升
- 平台期 → 暂停或完成

### Tab 3: 系统资源

```
Y轴：使用率（%）
X轴：时间（时分秒）

红色曲线：CPU使用率
黄色曲线：内存使用率
青色曲线：活跃连接数（×10）
```

**分析要点：**
- CPU高 → 计算密集
- 内存高 → 可能内存泄漏
- 连接数增长 → 连接泄漏警告
- 连接数稳定 → 连接管理正常

---

## 故障排查

### 问题1：图表不更新

**可能原因：**
- 下载目录不正确
- 目录中没有 `.nc` 文件
- 下载程序未运行

**解决方法：**
1. 检查下载目录是否正确
2. 确认下载程序正在运行
3. 检查目录权限

### 问题2：速度显示为0

**可能原因：**
- 下载已完成
- 下载程序已停止
- 监控目录错误

**解决方法：**
1. 检查下载程序状态
2. 确认是否有正在进行的下载
3. 切换到正确的日期目录

### 问题3：图表更新缓慢

**可能原因：**
- 更新间隔设置过长
- 系统性能不足
- 数据点过多

**解决方法：**
1. 降低更新间隔（1-2秒）
2. 减少显示时间范围
3. 关闭其他程序释放资源

### 问题4：matplotlib导入错误

**解决方法：**
```bash
uv add matplotlib
```

---

## 数据分析示例

### 场景1：检测速度衰减

**观察：**
- 30分钟内速度从 15 MB/s 降到 5 MB/s
- 衰减率：67%

**诊断：**
- 切换到"系统资源"Tab
- 检查活跃连接数是否增长
- 检查是否有大量网络错误

**解决方案：**
- 连接数增长 → 连接泄漏，使用修复版程序
- 大量错误 → S3限流，降低线程数或使用限流器

### 场景2：验证优化效果

**优化前：**
```
平均速度: 8.5 MB/s
最低速度: 2.1 MB/s
速度波动: 剧烈
```

**优化后（使用v1.0.0修复版）：**
```
平均速度: 12.3 MB/s (↑45%)
最低速度: 10.1 MB/s (↑380%)
速度波动: 平稳
```

### 场景3：对比不同配置

**测试1（5个线程）：**
```
平均速度: 15.2 MB/s
网络错误: 23次
```

**测试2（2个线程）：**
```
平均速度: 11.8 MB/s
网络错误: 3次
```

**结论：** 降低线程数虽然速度略慢，但稳定性大幅提升

---

## 高级用法

### 导出数据到Excel

1. 点击"导出数据"
2. 保存为 `.csv` 文件
3. 用Excel打开
4. 创建自定义图表和分析

### Python数据分析

```python
import pandas as pd
import matplotlib.pyplot as plt

# 读取CSV
df = pd.read_csv('era5_performance_20260209_123045.csv')

# 转换时间
df['时间'] = pd.to_datetime(df['时间'])

# 绘制速度图
plt.figure(figsize=(12, 6))
plt.plot(df['时间'], df['下载速度(MB/s)'])
plt.title('下载速度趋势')
plt.xlabel('时间')
plt.ylabel('速度 (MB/s)')
plt.xticks(rotation=45)
plt.grid(True)
plt.show()

# 统计分析
print(f"平均速度: {df['下载速度(MB/s)'].mean():.2f} MB/s")
print(f"最高速度: {df['下载速度(MB/s)'].max():.2f} MB/s")
print(f"标准差: {df['下载速度(MB/s)'].std():.2f}")
```

### 长期监控建议

**持续监控（几天到几周）：**
1. 每天启动监控器
2. 设置时间范围为"全部"
3. 导出每日数据
4. 对比不同时段的性能

**自动化监控：**
```bash
# 创建批处理脚本自动启动
@echo off
start /min ERA5download_GUI_v2_fixed.py
timeout /t 30
start /min era5_performance_monitor.py
```

---

## 数据库说明

### 数据库位置

```
D:\wzl\ERA5下载软件\era5_performance.db
```

### 数据表结构

```sql
CREATE TABLE performance_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp REAL UNIQUE,          -- Unix时间戳
    datetime TEXT,                   -- 格式化时间
    download_speed REAL,             -- 下载速度（bytes/s）
    total_downloaded REAL,           -- 累计下载（bytes）
    active_threads INTEGER,          -- 活跃连接数
    cpu_usage REAL,                  -- CPU使用率（%）
    memory_usage REAL,               -- 内存使用率（%）
    network_errors INTEGER           -- 网络错误数
);
```

### 直接查询数据库

```bash
sqlite3 era5_performance.db

# 查询最近10条记录
SELECT * FROM performance_logs ORDER BY timestamp DESC LIMIT 10;

# 查询平均速度
SELECT AVG(download_speed) / 1048576 as avg_speed_mbps
FROM performance_logs;

# 查询每小时统计数据
SELECT
    strftime('%Y-%m-%d %H:00:00', datetime) as hour,
    AVG(download_speed) / 1048576 as avg_speed,
    MAX(download_speed) / 1048576 as max_speed
FROM performance_logs
GROUP BY hour
ORDER BY hour;
```

---

## 性能指标说明

### 速度评估标准

| 速度范围 | 评级 | 说明 |
|---------|------|------|
| > 20 MB/s | 优秀 | 网络和服务器状态极佳 |
| 15-20 MB/s | 良好 | 正常高速下载 |
| 10-15 MB/s | 一般 | 标准下载速度 |
| 5-10 MB/s | 较慢 | 可能有网络问题或限流 |
| < 5 MB/s | 很慢 | 需要检查网络或降低线程数 |

### 资源使用标准

| 指标 | 正常 | 警告 | 危险 |
|------|------|------|------|
| CPU使用率 | < 50% | 50-80% | > 80% |
| 内存使用率 | < 60% | 60-85% | > 85% |
| 活跃连接数 | 5-15 | 15-30 | > 30 |

---

## 常见问题

### Q1：监控器会影响下载速度吗？

**A：** 不会。监控器使用独立进程，资源占用很小（< 1% CPU, < 50MB内存）。

### Q2：可以同时监控多个目录吗？

**A：** 当前版本只能监控一个目录。如需监控多个，可以启动多个监控器实例。

### Q3：数据库会无限增长吗？

**A：** 会。建议定期清理或归档旧数据：
```bash
# 删除30天前的数据
sqlite3 era5_performance.db "DELETE FROM performance_logs WHERE timestamp < $(date -d '30 days ago' +%s)"
```

### Q4：可以在远程服务器上使用吗？

**A：** 可以，但需要X11转发或使用Web界面版本。

### Q5：支持命令行模式吗？

**A：** 当前版本仅支持GUI模式，可以后续添加CLI模式。

---

## 更新日志

### v1.0.0 (2026-02-09)

**新增功能：**
- 实时速度监控（折线图）
- 累计下载量监控
- 系统资源监控
- SQLite数据持久化
- CSV数据导出
- 统计分析报告

**已知问题：**
- 大量数据点时可能卡顿
- 不支持远程监控

**计划改进：**
- Web界面版本
- 命令行模式
- 自动化报告生成
- 邮件告警功能

---

**祝你监控愉快！**

如有问题或建议，请反馈。
