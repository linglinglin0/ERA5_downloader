# 性能监控器 - 速度显示0问题 - 已修复！

## 问题根源

### ✅ 已修复：断点续传文件监控

**问题原因：**
- ERA5下载器使用断点续传功能
- 正在下载的文件是 `.tmp` 后缀（临时文件）
- 下载完成后才重命名为 `.nc`
- 原监控器只监控 `.nc` 文件，无法检测到正在下载的 `.tmp` 文件

**修复方案：**
现在同时监控 `.nc` 和 `.tmp` 文件！

---

## 修复后的行为

### 修复前
```
只监控 .nc 文件
↓
正在下载的文件: e5.oper.xxx.tmp  ← 不计入
已完成的文件: e5.oper.xxx.nc    ← 计入
↓
结果：正在下载时速度显示0 ❌
```

### 修复后
```
同时监控 .nc 和 .tmp 文件
↓
正在下载的文件: e5.oper.xxx.tmp  ← 计入 ✅
已完成的文件: e5.oper.xxx.nc    ← 计入 ✅
↓
结果：实时显示下载速度 ✅
```

---

## 验证修复

### 启动监控器后应该看到：

```
[Collector] 正在计算初始大小...
[Collector] 下载目录: D:\ERA5数据\202510
[Collector] 找到 5 个 .nc 文件, 3 个 .tmp 文件  ← 显示两种文件
[Collector] 初始大小: 850.50 MB (0.83 GB)
[Collector] 首次采集 - 初始大小: 850.50 MB
[Collector] 当前大小: 851.20 MB, 已下载: 0.70 MB, 速度: 128.45 KB/s  ← 速度正常！
```

**关键指标：**
- ✅ 显示 `.nc` 和 `.tmp` 文件数量
- ✅ 速度 > 0（有文件在下载）
- ✅ "已下载"和"当前大小"在增长

---

## ERA5下载器文件生命周期

### 文件状态转换

```
1. 开始下载
   ↓
   e5.oper.an.pl.128_130_t.ll025sc.2025100100_2025100100.tmp
   (正在下载，大小持续增长)
   ↓
2. 下载完成
   ↓
   重命名:
   e5.oper.an.pl.128_130_t.ll025sc.2025100100_2025100100.tmp
   → e5.oper.an.pl.128_130_t.ll025sc.2025100100_2025100100.nc
   ↓
3. 断点续传
   ↓
   如果中断，下次从 .tmp 文件继续
```

---

## 正确使用方式

### 第1步：配置下载器
```
日期: 202510
保存根目录: D:\ERA5数据
线程数: 5
```

### 第2步：启动下载器
```
点击"开始下载"
等待扫描："共 150 个文件"
下载开始
```

### 第3步：启动监控器
```
选择目录: D:\ERA5数据\202510  ← 日期目录
点击"开始监控"
```

### 第4步：观察输出
```
控制台应显示：
[Collector] 找到 X 个 .nc 文件, Y 个 .tmp 文件  ← Y > 0 表示正在下载
[Collector] 当前大小: XXX.XX MB, 速度: XXX KB/s  ← 速度 > 0
```

---

## 文件数量说明

### 正常情况

**刚开始下载：**
```
[Collector] 找到 0 个 .nc 文件, 3 个 .tmp 文件
解释: 3个文件正在下载，还未完成
```

**下载一段时间后：**
```
[Collector] 找到 5 个 .nc 文件, 3 个 .tmp 文件
解释: 5个已完成，3个正在下载
```

**全部完成：**
```
[Collector] 找到 150 个 .nc 文件, 0 个 .tmp 文件
解释: 所有文件已下载完成
```

### 异常情况

**一直显示0个文件：**
```
[Collector] 找到 0 个 .nc 文件, 0 个 .tmp 文件
原因: 目录选择错误或下载还没开始
```

---

## 实时监控验证

### 方法1：查看文件变化

在文件资源管理器中：
```
1. 打开下载目录
2. 按"详细信息"查看
3. 排序方式: 按"修改时间"降序
4. 观察文件大小是否在增长
```

**应该看到：**
```
e5.oper.xxx.tmp  正在增长  ← 下载中
e5.oper.xxx.tmp  正在增长  ← 下载中
e5.oper.xxx.nc   大小固定  ← 已完成
```

### 方法2：使用命令行监控

```bash
# 进入下载目录
cd D:\ERA5数据\202510

# 每5秒查看一次文件列表
:loop
dir *.nc *.tmp
timeout /t 5
goto loop
```

---

## 性能监控器功能说明

### 监控内容

**文件大小：**
- 所有 `.nc` 文件大小
- 所有 `.tmp` 文件大小
- 总计 = `.nc` + `.tmp`

**速度计算：**
```python
速度 = (当前总大小 - 上次总大小) / 时间间隔
```

**滑动平均：**
- 使用最近5次速度的平均值
- 避免速度剧烈波动

---

## 图表显示

### 速度图表
- Y轴：MB/s
- 可以显示小到 0.01 MB/s 的速度
- 使用滑动平均，曲线平滑

### 下载量图表
- 左Y轴（绿色）：GB
- 右Y轴（橙色）：MB
- 同时显示已完成(.nc)和下载中(.tmp)的文件

---

## 常见问题

### Q1: 为什么有时候速度会跳动？

**A:**
- 因为 `.tmp` 文件写入是突发的
- 使用了滑动平均来平滑
- 但仍会有正常波动

### Q2: 文件完成后速度会下降吗？

**A:**
- 会！因为一个 `.tmp` 完成后变成 `.nc`
- 在这个瞬间没有新的下载，速度会暂时下降
- 然后下一个文件开始下载，速度恢复

### Q3: 监控器会影响下载速度吗？

**A:**
- 不会！
- 监控器每2秒才扫描一次目录
- 只读取文件大小，不修改文件
- 资源占用 < 1% CPU

### Q4: 可以监控多个日期目录吗？

**A:**
- 当前版本只能监控一个目录
- 如需监控多个，启动多个监控器实例

---

## 断点续传原理

### ERA5下载器实现

```
1. 开始下载文件A
   ↓
   创建: fileA.tmp
   ↓
2. 写入数据（Range请求）
   ↓
   fileA.tmp 大小持续增长
   ↓
3. 下载完成
   ↓
   验证大小 → 重命名为 fileA.nc
   ↓
4. 如果中断：
   下次启动时检测到 fileA.tmp
   从断点位置继续下载
```

### 监控器如何处理

```
监控器每2秒扫描:
  总大小 = sum(所有 .nc) + sum(所有 .tmp)

增量 = 当前总大小 - 上次总大小
速度 = 增量 / 时间间隔
```

---

**修复完成！** ✅

现在监控器可以正确检测正在下载的 `.tmp` 文件了！

**关键点：**
- ✅ 同时监控 `.nc` 和 `.tmp` 文件
- ✅ 实时显示下载速度
- ✅ 准确计算已下载量
- ✅ 显示文件数量（已完成/下载中）

**请重新启动监控器测试！** 🚀
