# ERA5下载软件 - 诊断工具使用说明

## 📋 工具概览

我为您创建了两个诊断工具来验证性能问题：

### 1️⃣ 实时监控工具 (`diagnostic_tool.py`)
**功能：** 实时监控程序运行状态，检测连接泄漏和内存泄漏
**使用场景：** 在下载过程中运行，实时观察问题

### 2️⃣ 日志分析工具 (`log_analyzer.py`)
**功能：** 分析已有的错误日志，诊断问题根源
**使用场景：** 下载完成后或出现问题后分析

---

## 🚀 快速开始

### 方案A：实时监控（推荐）⭐

#### 步骤1：启动ERA5下载程序
```batch
cd D:\wzl\ERA5下载软件
启动程序_简化版.bat
```

开始下载任务...

#### 步骤2：启动实时监控
**打开新的命令行窗口，运行：**
```batch
cd D:\wzl\ERA5下载软件
C:\Users\Administrator\.local\bin\uv.exe run python diagnostic_tool.py
```

#### 步骤3：观察监控面板（每5秒刷新）

```
================================================================================
                    ERA5下载软件 - 实时诊断监控
================================================================================

📅 当前时间: 2026-02-08 15:30:25
⏱️  监控时长: 185 秒

📊 下载状态
────────────────────────────────────────────────────────────────────────────
  已完成文件数: 12
  当前速度: 0.08 文件/秒

🌐 网络连接状态（⚠️ 重点监控）
────────────────────────────────────────────────────────────────────────────
  ESTABLISHED连接: 18          ← 正常应该是5-10个
  总连接数: 23
  疑似泄漏连接: 5 ⚠️            ← 持续增长 = 连接泄漏
  连接趋势: 上升 📈 (10 → 18)   ← 应该保持稳定

❌ 错误与重试
────────────────────────────────────────────────────────────────────────────
  累计错误: 15
  累计重试: 42
  当前错误率: 0.12 错误/秒

💻 系统资源
────────────────────────────────────────────────────────────────────────────
  内存使用: 385.2 MB (12.3%)
  CPU使用: 15.3%
  线程数: 8
  打开文件数: 45

🏥 系统健康诊断
────────────────────────────────────────────────────────────────────────────
  ❌ 严重连接泄漏                ← 发现问题！
  ⚠️ 内存持续增长
  ⚠️ 错误率偏高

================================================================================
```

#### 步骤4：按 Ctrl+C 停止监控并查看报告

---

### 方案B：日志分析（已有错误日志）

如果您已经运行过下载并产生了错误日志：

#### 运行日志分析工具
```batch
cd D:\wzl\ERA5下载软件
C:\Users\Administrator\.local\bin\uv.exe run python log_analyzer.py
```

#### 输出示例

```
================================================================================
【错误类型统计】
================================================================================

总错误数: 47

错误类型                             次数         占比     严重程度
────────────────────────────────────────────────────────────────────────────
ConnectionError                        25       53.2%   🔴 高
TimeoutError                           12       25.5%   🔴 高
EndpointConnectionError                 7       14.9%   🔴 高
ClientError                             3        6.4%   🟡 中

🔴 诊断: 超过50%的错误是网络相关
💡 可能原因:
   1. HTTP响应未正确关闭导致连接泄漏
   2. 连接池大小不足
   3. 网络超时设置过短

✅ 建议:
   - 添加 response['Body'].close()
   - 增加 max_pool_connections
   - 增加超时时间到60秒

================================================================================
【错误时间分布】
================================================================================

小时          错误次数
────────────────────────────────────────────────────────────────────────────
14:00-14:59              8
15:00-15:59             15
16:00-16:59             24

前期平均错误/小时: 11.5
后期平均错误/小时: 19.5

🔴 诊断: 错误率随时间上升
💡 这表明存在资源泄漏或连接池耗尽问题

================================================================================
【综合诊断报告】
================================================================================

🔴 严重问题: 连接泄漏导致性能恶化

   问题特征:
   - 78.7% 的错误是网络连接问题
   - 随着时间推移错误率上升
   - 大量重试浪费时间

   根本原因:
   1. HTTP响应对象未关闭，连接无法返回池中
   2. 连接池逐渐耗尽，新请求失败
   3. 指数退避重试浪费大量时间

   ✅ 紧急修复（预计提升50-70%性能）:
   - 在 finally 块中添加 response['Body'].close()
   - 增加连接池大小: max_workers * 4
   - 优化重试策略，添加随机抖动
```

---

## 🔍 关键指标解读

### 网络连接状态（最重要）

| 指标 | 正常值 | 警告值 | 危险值 |
|------|--------|--------|--------|
| **ESTABLISHED连接** | 5-10 | 10-20 | 20+ |
| **疑似泄漏连接** | 0-2 | 3-5 | 5+ |
| **连接趋势** | 稳定 | 缓慢上升 | 快速上升 |

**判断标准：**
- ✅ ESTABLISHED连接保持在并发线程数的2倍左右
- ⚠️ 如果持续增长，说明存在连接泄漏
- 🔴 如果超过50个，说明连接池已严重泄漏

### 内存使用

| 监控时长 | 正常增长 | 警告增长 | 危险增长 |
|----------|----------|----------|----------|
| 1小时 | <50 MB | 50-100 MB | >100 MB |
| 2小时 | <100 MB | 100-200 MB | >200 MB |
| 4小时 | <200 MB | 200-400 MB | >400 MB |

### 错误率

| 错误率 | 状态 | 说明 |
|--------|------|------|
| <0.01/秒 | ✅ 优秀 | 网络稳定 |
| 0.01-0.05/秒 | 🟡 可接受 | 偶发错误 |
| 0.05-0.1/秒 | 🟠 偏高 | 需要关注 |
| >0.1/秒 | 🔴 严重 | 存在问题 |

---

## 📊 诊断检查清单

使用工具后，根据以下清单判断问题：

### ✅ 问题确认标准

**如果出现以下情况，确认存在连接泄漏：**

- [ ] ESTABLISHED连接数持续增长（5 → 10 → 20 → 40）
- [ ] 疑似泄漏连接 > 5
- [ ] 网络错误占比 > 50%
- [ ] 错误率随时间上升

**如果出现以下情况，确认存在内存泄漏：**

- [ ] 内存每分钟增长 > 10 MB
- [ ] 长时间运行后内存增长 > 500 MB
- [ ] CPU占用持续上升（GC频繁）

**如果出现以下情况，确认存在重试风暴：**

- [ ] 重试次数 / 错误次数 > 2
- [ ] 大量错误集中在同一时间段
- [ ] 下载速度随时间明显下降

---

## 🎯 下一步行动

### 情况A：确认问题严重（推荐修复）

如果诊断工具显示：
- 连接泄漏严重
- 错误率 > 50%
- 性能随时间明显恶化

**建议：** 立即修复代码
- 预计工作量：2-3小时
- 预期收益：性能提升 50-70%

### 情况B：问题轻微（可选修复）

如果诊断工具显示：
- 连接数稳定
- 错误率 < 20%
- 性能基本稳定

**建议：** 可以选择性优化
- 预计工作量：1小时
- 预期收益：性能提升 10-20%

### 情况C：未发现问题

**建议：** 继续监控
- 定期运行诊断工具
- 关注长期运行趋势

---

## 📝 使用技巧

### 1. 最佳监控时机

**推荐监控时长：**
- **快速验证：** 30分钟
- **中期观察：** 2-4小时
- **长期测试：** 24小时

**最佳观察时间点：**
- 下载开始后10分钟（初始状态）
- 下载进行到1小时（中期状态）
- 下载进行到4小时（问题暴露期）

### 2. 数据收集

**保存监控数据：**
```python
# 在 diagnostic_tool.py 中添加
def export_metrics(self, filename='metrics.json'):
    """导出监控数据"""
    import json
    data = {k: list(v) for k, v in self.metrics.items()}
    with open(filename, 'w') as f:
        json.dump(data, f)
```

### 3. 对比测试

**修复前后对比：**
1. 修复前运行监控1小时，导出数据
2. 应用修复代码
3. 修复后运行监控1小时，导出数据
4. 对比关键指标的变化

---

## ❓ 常见问题

### Q1: 找不到目标进程？
**A:**
- 确保ERA5下载程序正在运行
- 检查是否是以管理员权限运行
- 尝试以管理员身份运行诊断工具

### Q2: 监控显示无权限访问进程？
**A:**
- 以管理员身份运行命令行
```batch
# 右键"命令提示符" → "以管理员身份运行"
```

### Q3: 没有错误日志文件？
**A:**
- 需要先运行下载程序并产生错误
- 或者开启详细日志记录

### Q4: 监控面板刷新太快看不清？
**A:**
- 修改 diagnostic_tool.py 中的 interval 参数
```python
monitor = DiagnosticMonitor(interval=10)  # 改为10秒刷新
```

---

## 📞 技术支持

如需帮助，可以：
1. 保存监控数据和日志
2. 截图诊断报告
3. 记录具体的问题现象

然后进行下一步讨论和修复。

---

**准备好了吗？**

建议先运行 **30分钟实时监控**，看看能否复现我们分析的问题！

```batch
# 终端1：启动下载
启动程序_简化版.bat

# 终端2：启动监控
C:\Users\Administrator\.local\bin\uv.exe run python diagnostic_tool.py
```
