# ERA5性能验证 - 操作指南

## 🎯 目标
验证随着时间增长，ERA5下载软件会出现：
1. 网络连接泄漏
2. 下载速度变慢
3. 频繁重试的问题

---

## 📝 完整操作步骤

### 第1步：启动ERA5下载程序

打开**命令行窗口1**，执行：

```batch
cd D:\wzl\ERA5下载软件
启动程序_简化版.bat
```

或者：
```batch
C:\Users\Administrator\.local\bin\uv.exe run python ERA5download_GUI_v2.py
```

在弹出的GUI界面中：
1. 输入日期：`202102`（或其他有数据的月份）
2. 点击"选择文件夹"设置保存位置
3. 并发线程数：设置为 `5`
4. **变量选择：留空**（下载全部数据，更容易观察问题）
5. 点击"开始下载"

✅ 确认下载开始，看到进度条和速度显示

---

### 第2步：启动诊断监控工具

打开**新的命令行窗口2**，执行：

```batch
cd D:\wzl\ERA5下载软件
启动诊断工具.bat
```

或者：
```batch
C:\Users\Administrator\.local\bin\uv.exe run python diagnostic_tool.py
```

✅ 应该看到监控面板开始刷新

---

### 第3步：观察关键指标（持续30分钟以上）

#### 🌐 网络连接状态（最重要）

**正常情况：**
```
ESTABLISHED连接: 5-10      ← 保持稳定
疑似泄漏连接: 0-2          ← 保持低位
连接趋势: 稳定 ➡️          ← 不应该持续增长
```

**问题症状（如果存在）：**
```
ESTABLISHED连接: 5 → 10 → 20 → 40  ← 持续增长
疑似泄漏连接: 0 → 3 → 8 → 15       ← 持续增长
连接趋势: 上升 📈                  ← 明确警告
```

#### 📊 下载速度

**正常情况：**
```
当前速度: 30-50 MB/s     ← 保持稳定
完成文件数: 稳定增长
```

**问题症状：**
```
开始: 50 MB/s
30分钟后: 30 MB/s        ← 下降40%
1小时后: 20 MB/s         ← 下降60%
2小时后: 10 MB/s         ← 下降80%
```

#### ❌ 错误与重试

**正常情况：**
```
累计错误: 0-5次
累计重试: 0-10次
```

**问题症状：**
```
30分钟: 5次错误, 15次重试
1小时:  25次错误, 75次重试      ← 错误率上升
2小时:  80次错误, 240次重试     ← 严重恶化
```

#### 💻 系统资源

**正常情况：**
```
内存使用: 200-300 MB        ← 缓慢增长
内存趋势: 5分钟增长 < 10 MB
```

**问题症状：**
```
内存使用: 200 → 400 → 800 MB      ← 快速增长
内存趋势: 5分钟增长 > 50 MB        ← 泄漏警告
```

---

### 第4步：停止监控并查看报告

在监控窗口按 `Ctrl+C`，工具会自动生成诊断报告：

```
================================================================================
                          综合诊断报告
================================================================================

【诊断结论】

🔴 严重问题: 连接泄漏导致性能恶化
   - 78.7% 的错误是网络连接问题
   - 连接数呈上升趋势
   - 大量重试浪费时间

✅ 紧急修复（预计提升50-70%性能）:
   - 添加 response['Body'].close()
   - 增加连接池大小
   - 优化重试策略
```

---

## 📋 问题确认检查表

运行30分钟后，根据以下标准判断：

### 连接泄漏检查

- [ ] ESTABLISHED连接从5-10个增长到20+个
- [ ] 疑似泄漏连接 > 5
- [ ] 连接趋势显示"上升📈"

**如果勾选≥2项 → 确认存在连接泄漏**

### 性能恶化检查

- [ ] 下载速度下降 > 30%
- [ ] 错误率随时间上升
- [ ] 重试次数 > 错误次数的2倍

**如果勾选≥2项 → 确认性能随时间恶化**

### 资源泄漏检查

- [ ] 内存每分钟增长 > 10 MB
- [ ] 30分钟内存增长 > 200 MB

**如果勾选≥1项 → 可能存在内存泄漏**

---

## 🎯 预期结果

### 如果我们的分析正确（问题确实存在）：

✅ **会观察到：**
1. 连接数从5个持续增长到30+个
2. 下载速度从100%下降到40%以下
3. 错误率从5%上升到30%+
4. 大量重试浪费的时间

✅ **诊断报告会显示：**
- 严重问题：连接泄漏
- 网络错误占比 > 50%
- 错误率随时间上升

### 如果不存在问题（代码已优化或问题不严重）：

✅ **会观察到：**
1. 连接数保持稳定（5-10个）
2. 下载速度基本稳定
3. 错误率 < 10%
4. 无明显资源泄漏

✅ **诊断报告会显示：**
- 系统运行正常
- 无严重问题

---

## ⏱️ 建议监控时长

| 监控时长 | 能检测到的问题 |
|----------|----------------|
| **10分钟** | 初始状态，基准值 |
| **30分钟** | 轻微问题开始显现 |
| **1小时** | 明确的趋势变化 |
| **2-4小时** | 严重问题充分暴露 |

**推荐：至少运行30分钟，最好1-2小时**

---

## 💡 提示

1. **两个窗口同时运行**：一个窗口下载，一个窗口监控
2. **保存监控截图**：定期截图保存数据
3. **记录关键时间点**：注意何时开始出现问题
4. **不要停止下载**：让程序持续运行以观察完整趋势

---

## 🚀 准备开始了吗？

**请按顺序执行：**

1. 打开窗口1：启动下载程序
2. 开始下载任务
3. 打开窗口2：启动诊断工具
4. 观察至少30分钟
5. 告诉我观察到的结果

准备好了吗？需要我解释任何步骤吗？
