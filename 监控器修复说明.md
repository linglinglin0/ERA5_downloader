# 性能监控器修复说明

## 修复日期
2026-02-09

## 修复的问题

### 1. 初始速度显示异常高（40000+ MB/s）

**原因：**
- 第一次采集时，`time_elapsed` 可能非常小（< 0.001秒）
- 公式：`speed = (current_size - last_size) / time_elapsed`
- 如果瞬间有数据写入，会产生巨大的速度值

**修复方案：**
```python
# 添加首次采集标记
self.first_collection = True

# 首次采集时重置时间戳
if self.first_collection:
    self.last_time = current_time
    self.last_size = current_size
    self.first_collection = False
    time_elapsed = 0
```

---

### 2. 下载速度持续显示为0

**原因：**
- 数据采集间隔太短时，时间间隔不足1秒
- 导致 `download_speed = 0`

**修复方案：**
```python
# 确保至少有1秒的时间间隔
if time_elapsed >= 1.0:
    download_speed = (current_size - self.last_size) / time_elapsed
else:
    download_speed = 0  # 使用上次速度
```

---

### 3. 无法显示KB级别的速度

**原因：**
- 原来固定使用MB/s单位
- KB/s的速度被显示为0 MB/s

**修复方案：**
添加智能单位转换函数：
```python
def _format_speed(self, speed_bytes_per_second):
    """智能格式化速度显示"""
    if speed_bytes_per_second == 0:
        return "0 KB/s"

    if speed_bytes_per_second < 1024 * 1024:
        # KB/s
        return f"{speed_bytes_per_second / 1024:.2f} KB/s"
    elif speed_bytes_per_second < 1024 * 1024 * 1024:
        # MB/s
        return f"{speed_bytes_per_second / (1024 * 1024):.2f} MB/s"
    else:
        # GB/s
        return f"{speed_bytes_per_second / (1024 ** 3):.2f} GB/s"
```

**显示效果：**
```
0.5 MB/s  → 512.00 KB/s  ✅
2.3 MB/s  → 2.30 MB/s     ✅
15.8 MB/s → 15.80 MB/s    ✅
```

---

### 4. 总下载大小单位单一

**原因：**
- 原来只显示GB单位
- 小于1GB时显示为0.XX GB，不够直观

**修复方案：**
1. **统计面板显示：**
```python
def _format_size(self, size_bytes):
    """智能格式化大小显示"""
    if size_bytes == 0:
        return "0 MB"

    size_mb = size_bytes / (1024 * 1024)
    size_gb = size_bytes / (1024 ** 3)

    if size_gb >= 1:
        # 同时显示GB和MB
        return f"{size_gb:.2f} GB ({size_mb:.0f} MB)"
    else:
        # 小于1GB显示MB
        return f"{size_mb:.2f} MB"
```

**显示效果：**
```
500 MB   → 500.00 MB                    ✅
1.2 GB   → 1.20 GB (1229 MB)            ✅
15.8 GB  → 15.80 GB (16179 MB)           ✅
```

2. **图表双Y轴显示：**
```python
# 左Y轴：GB
# 右Y轴：MB（自动成比例）
self.ax_downloaded_gb = self.ax_downloaded
self.ax_downloaded_mb = self.ax_downloaded.twinx()

# 设置右轴比例
gb_min, gb_max = self.ax_downloaded_gb.get_ylim()
self.ax_downloaded_mb.set_ylim(
    bottom=gb_min * 1024,
    top=gb_max * 1024
)
```

---

## 修复效果对比

### 修复前

```
当前速度: 42857.23 MB/s  ❌ 异常
当前速度: 0.00 MB/s       ❌ 无法显示小速度
已下载: 0.05 GB          ❌ 不够直观
```

### 修复后

```
当前速度: 512.45 KB/s     ✅ 准确且清晰
当前速度: 2.35 MB/s       ✅ 准确且清晰
已下载: 512.45 MB        ✅ 直观
已下载: 1.20 GB (1229 MB) ✅ 双单位显示
```

---

## 新增功能

### 1. 智能速度显示

自动选择合适的单位：
- < 1 MB/s → 显示 KB/s
- 1 MB/s - 1 GB/s → 显示 MB/s
- ≥ 1 GB/s → 显示 GB/s

### 2. 智能大小显示

自动选择合适的单位组合：
- < 1 GB → 显示 MB
- ≥ 1 GB → 显示 GB (MB)

### 3. 双Y轴下载量图表

- 左轴：GB（绿色）
- 右轴：MB（橙色）
- 两轴自动同步

### 4. 增强的CSV导出

导出的CSV包含多单位数据：
```csv
时间,下载速度(MB/s),下载速度(KB/s),累计下载(GB),累计下载(MB),...
```

---

## 使用说明

### 查看速度

**实时统计面板：**
- 自动显示最适合的单位
- KB/s、MB/s 或 GB/s

**速度图表：**
- Y轴使用 MB/s 作为基本单位
- 可以显示小到 0.01 MB/s 的值
- Y轴从0开始，避免负值

### 查看下载量

**实时统计面板：**
```
已下载: 1.20 GB (1229 MB)  ← 双单位显示
```

**下载量图表：**
- 左Y轴（绿色）：GB
- 右Y轴（橙色）：MB
- 两个Y轴自动成比例

### 导出数据

CSV文件包含多个单位列：
- 下载速度(MB/s)
- 下载速度(KB/s)
- 累计下载(GB)
- 累计下载(MB)

方便在Excel中选择合适的单位进行分析。

---

## 技术细节

### 速度计算逻辑

```python
# 1. 检查是否首次采集
if self.first_collection:
    # 重置基准，避免异常
    self.last_time = current_time
    self.last_size = current_size
    self.first_collection = False
    return speed=0

# 2. 确保最小时间间隔
if time_elapsed >= 1.0:
    download_speed = (current_size - self.last_size) / time_elapsed
else:
    download_speed = 0  # 时间太短，不更新

# 3. 更新基准
self.last_size = current_size
self.last_time = current_time
```

### 智能单位转换

```python
# 速度单位判断
if speed < 1 MB/s:
    unit = "KB/s"
    value = speed / 1024
elif speed < 1 GB/s:
    unit = "MB/s"
    value = speed / (1024 * 1024)
else:
    unit = "GB/s"
    value = speed / (1024 ** 3)

# 大小单位判断
if size < 1 GB:
    display = f"{size_mb:.2f} MB"
else:
    display = f"{size_gb:.2f} GB ({size_mb:.0f} MB)"
```

---

## 已知限制

1. **图表Y轴单位固定**
   - 速度图表：始终使用 MB/s
   - 但可以显示小数值（0.01 MB/s = 10.24 KB/s）

2. **首次采集需等待**
   - 第一次采集会重置基准
   - 等待1秒后才能显示正确的速度

3. **双Y轴同步**
   - 右Y轴（MB）必须与左Y轴（GB）成1024倍
   - 自动计算，但显示时可能有小数误差

---

## 更新建议

如果需要更细致的速度显示，可以考虑：
1. 添加速度图表的Y轴单位选择器
2. 使用对数刻度显示大范围速度
3. 添加速度分布直方图

---

**修复完成！** ✅

现在性能监控器可以：
- ✅ 准确显示从KB/s到GB/s的速度
- ✅ 避免初始异常值
- ✅ 同时显示GB和MB单位
- ✅ 智能选择最适合的单位
