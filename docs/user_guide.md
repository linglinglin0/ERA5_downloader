# 用户指南

## 目录

1. [快速开始](#快速开始)
2. [界面说明](#界面说明)
3. [下载流程](#下载流程)
4. [断点续传](#断点续传)
5. [常见问题](#常见问题)
6. [性能优化](#性能优化)

---

## 快速开始

### 安装步骤

1. **安装 Python**
   - 下载 Python 3.8 或更高版本
   - 安装时勾选 "Add Python to PATH"

2. **克隆项目**
   ```bash
   git clone https://github.com/your-username/ERA5-downloader.git
   cd ERA5-downloader
   ```

3. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

4. **运行程序**
   - Windows: 双击 `scripts\windows\launch_app.bat`
   - 其他: 运行 `python era5/gui.py`

---

## 界面说明

### 主界面布局

```
┌─────────────────────────────────────────────────┐
│  ERA5 下载助手                                │
├──────────────┬──────────────────────────────────┤
│              │                                  │
│  日期设置     │   变量选择区                  │
│  202510      │   ☑ 温度 (t)                │
│              │   ☐ 湿度 (q)                │
│  保存目录     │   ☑ 风速 (u, v)            │
│ [选择文件夹]  │                                  │
│              │   ┌────────────────────────┐   │
│  线程数      │   │  下载进度监控         │   │
│  ━━━━━━     │   │  当前速度: 5.2 MB/s   │   │
│  5个线程      │   │                        │   │
│              │   │  线程1: [████] 80%    │   │
│ [开始下载]    │   │  线程2: [████] 40%    │   │
│ [停止并关闭]  │   │  线程3: [██] 20%      │   │
│              │   └────────────────────────┘   │
└──────────────┴──────────────────────────────────┘
```

### 功能说明

**左侧设置栏：**
- **日期设置**: 输入目标年月（YYYYMM 格式）
- **保存目录**: 点击选择数据保存位置
- **线程数**: 拖动滑块调整并发线程（1-10）
- **控制按钮**: 开始/停止下载

**右侧主区域：**
- **变量选择**: 勾选需要下载的气象变量
- **监控面板**: 实时显示下载进度和速度
- **系统日志**: 显示当前状态和错误信息

---

## 下载流程

### 标准下载流程

1. **输入日期**
   ```
   格式：YYYYMM
   示例：202510 表示 2025年10月
   ```

2. **选择保存目录**
   - 点击"选择文件夹"按钮
   - 浏览并选择目标位置
   - 建议选择有足够空间的磁盘（每个月约 50-100GB）

3. **选择变量（可选）**
   - 不勾选：下载所有变量
   - 勾选部分：只下载选中的变量
   - 常用变量：
     - `t` - 空气温度
     - `u, v` - 风速分量
     - `q` - 比湿
     - `r` - 相对湿度

4. **设置并发线程**
   - 推荐设置：3-5 个线程
   - 网络较好：5-8 个线程
   - 网络一般：2-3 个线程

5. **开始下载**
   - 点击"开始下载"按钮
   - 观察监控面板确认进度

### 下载进度说明

监控面板会显示：
- **线程状态**: 每个线程正在下载的文件
- **进度百分比**: 实时更新（0-100%）
- **下载速度**: 每秒下载的数据量
- **系统日志**: 当前状态和提示信息

**正常下载示例：**
```
线程-1: [t] ...e5.oper.an.pl.202510/...t.nc        [████████] 100%
线程-2: [u] ...e5.oper.an.pl.202510/...u.nc        [███████]  80%
线程-3: [v] ...e5.oper.an.pl.202510/...v.nc        [█████]   60%
当前速度: 5.2 MB/s
```

---

## 断点续传

### 工作原理

断点续传功能会在下载中断后保留临时文件（`.tmp` 后缀），下次继续下载时自动恢复。

**支持的恢复场景：**
- ✅ 网络连接中断
- ✅ 程序被关闭
- ✅ 系统重启或崩溃
- ✅ 手动停止下载

### 使用方法

**正常中断：**
1. 点击"停止并关闭"按钮
2. 程序会保存临时文件
3. 下次启动时自动继续

**异常中断：**
1. 重新运行程序
2. 输入相同的日期和目录
3. 点击"开始下载"
4. 程序自动检测未完成文件并继续

**续传日志示例：**
```
系统日志: 共 120 个文件，已完成 45，剩余 75
线程-1: [断点续传 45.2MB] ...temperature.nc
```

### 清理临时文件

如果不需要续传，可以手动删除 `.tmp` 文件：

**Windows:**
```cmd
del /s *.tmp
```

**Linux/Mac:**
```bash
find . -name "*.tmp" -delete
```

---

## 常见问题

### Q1: 下载速度很慢怎么办？

**可能原因：**
1. 并发线程数过低
2. 网络带宽限制
3. S3 服务器负载高

**解决方法：**
- 增加线程数（5 → 8）
- 检查网络连接
- 避开高峰时段下载

### Q2: 显示"网络错误"怎么办？

**错误示例：**
```
网络错误，5秒后重试 (1/6)
```

**这是正常的：**
- 程序会自动重试（最多 6 次）
- 采用指数退避策略（5s, 10s, 20s...）
- 大部分情况会自动恢复

**如果持续失败：**
1. 运行诊断工具：`python scripts/diagnostic.py`
2. 检查网络连接
3. 降低并发线程数
4. 重启程序

### Q3: 部分文件下载失败？

**失败提示：**
```
下载完成，但 3 个文件失败
```

**查看失败详情：**
1. 记录弹窗中显示的文件列表
2. 查看 `download_errors.log` 获取详细错误
3. 失败文件会保留 `.tmp` 临时文件

**重新下载失败文件：**
- 方法 1: 再次点击"开始下载"（会跳过已完成文件）
- 方法 2: 手动删除对应的 `.tmp` 文件后重新下载

### Q4: 提示"文件不完整"？

**原因：**
- 下载过程中出现错误
- 文件大小与服务器不匹配

**解决：**
1. 查看错误日志：`download_errors.log`
2. 删除不完整文件
3. 重新开始下载（会自动续传）

### Q5: 如何查看下载是否完整？

**检查方法：**
1. 观察系统日志：显示"所有任务完成！"
2. 查看文件夹：无 `.tmp` 临时文件
3. 运行诊断工具检查文件完整性

---

## 性能优化

### 推荐配置

**小型下载（< 10GB）：**
```
线程数: 3-5
预期速度: 3-5 MB/s
```

**中型下载（10-50GB）：**
```
线程数: 5-7
预期速度: 5-8 MB/s
```

**大型下载（> 50GB）：**
```
线程数: 7-10
预期速度: 8-12 MB/s
```

### 性能监控

**查看实时速度：**
- 主界面右上方显示当前速度
- 单位：MB/s（兆字节/秒）

**性能基准：**
- 良好：> 8 MB/s
- 正常：5-8 MB/s
- 较慢：< 5 MB/s

### 优化建议

1. **使用有线网络**
   - WiFi 可能不稳定
   - 以太网连接更可靠

2. **关闭后台程序**
   - 暂停自动更新
   - 关闭云同步服务

3. **选择合适时间**
   - 凌晨或清晨网络较快
   - 避开晚间高峰期

4. **磁盘空间充足**
   - 预留至少 200GB 空间
   - SSD 比 HDD 更快

---

## 高级功能

### 多个月份批量下载

如需下载多个月份：
1. 逐个月份下载
2. 或使用命令行批量启动（需开发）

### 只下载特定变量

在变量选择区勾选需要的变量：
- 温度数据：勾选 `t`
- 湿度数据：勾选 `q, r`
- 风场数据：勾选 `u, v`

### 查看详细日志

程序会在根目录生成：
- `download_errors.log` - 错误日志
- `.era5_download_progress.json` - 进度文件
- `.era5_gui_config.json` - 配置文件

---

## 技术支持

遇到问题？
1. 查看 [常见问题](#常见问题)
2. 运行诊断工具：`scripts\windows\run_diagnostic.bat`
3. 查看错误日志：`download_errors.log`
4. 提交 Issue：[GitHub Issues](https://github.com/your-username/ERA5-downloader/issues)

---

**版本**: 3.1.0
**更新日期**: 2025-02-14
**作者**: ERA5 Downloader Team
