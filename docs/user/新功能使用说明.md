# ERA5 下载器 - 新功能使用说明

## 📋 版本更新

**v2.1** (2026-01-19)

### ✨ 新增功能

1. **实时百分比显示** - 下载时显示详细的文字百分比进度
2. **配置自动记忆** - 记住日期、路径、变量选择等设置

---

## 🎯 功能 1: 实时百分比显示

### 改进说明

原版下载时只显示"下载中"或"开始下载"，不够直观。新版会在下载时实时显示文字百分比。

### 显示效果对比

#### ❌ 原版显示
```
线程-1: [t] ...20251001_00.nc
[==========     ] 50%
状态: 下载中
```

#### ✅ 新版显示
```
线程-1: [t] ...20251001_00.nc
[==========     ] 50%
状态: 50%
```

### 各种状态显示

| 状态 | 显示文本 | 说明 |
|------|---------|------|
| 开始下载 | `开始下载...` | 准备开始 |
| 下载中 | `50%` | 显示实时百分比 ✨ |
| 重试中 | `50% (重试1)` | 百分比 + 重试次数 ✨ |
| 断点续传 | `断点续传 60.5MB` | 已下载大小 ✨ |
| 网络错误 | `网络错误,4秒后重试(2/3)` | 倒计时 + 重试进度 |
| 已存在 | `已存在(跳过)` | 文件已完整 |
| 完成 | `完成` | 下载完成 |

### 进度更新频率

- **下载中**: 每 0.1 秒更新一次
- **完成时**: 立即显示 100%

---

## 💾 功能 2: 配置自动记忆

### 功能说明

关闭软件时，会自动保存以下设置：
- ✅ 日期 (YYYYMM)
- ✅ 保存根目录路径
- ✅ 并发线程数
- ✅ 勾选的变量列表

下次打开软件时，会自动恢复这些设置。

### 配置文件

**文件名**: `.era5_gui_config.json`
**位置**: 与程序在同一目录

#### 文件格式示例
```json
{
  "date": "202510",
  "local_root": "D:/ERA5数据",
  "thread_count": 5,
  "selected_vars": ["t", "u", "v", "q"]
}
```

### 自动保存时机

配置会在以下时机自动保存：

1. **日期变化时**
   - 输入完成后按回车
   - 输入框失去焦点

2. **路径变化时**
   - 选择新文件夹后立即保存

3. **线程数变化时**
   - 拖动滑块后 0.5 秒自动保存

4. **变量勾选变化时**
   - 勾选/取消勾选后 0.5 秒自动保存

5. **开始下载时**
   - 点击"开始下载"按钮

6. **关闭软件时**
   - 点击关闭按钮
   - 点击"停止并关闭"按钮

### 使用示例

#### 场景 1: 首次使用
```
1. 打开软件（显示默认设置）
2. 输入日期: 202510
3. 选择路径: D:/ERA5数据
4. 勾选变量: t, u, v
5. 点击"开始下载"
6. 下载完成后关闭软件
```

#### 场景 2: 再次打开
```
1. 打开软件（自动恢复上次设置）
   - 日期: 202510 ✅
   - 路径: D:/ERA5数据 ✅
   - 变量: t, u, v 已勾选 ✅
2. 直接点击"开始下载"即可
```

#### 场景 3: 修改部分设置
```
1. 打开软件（加载上次设置）
2. 修改日期为: 202511
3. 路径和变量保持不变
4. 点击"开始下载"
5. 新配置自动保存
```

---

## 🎨 界面变化

### 1. 变量选择区
- 每个复选框都有自动保存功能
- 勾选/取消后 0.5 秒自动保存

### 2. 日期输入框
- 输入完成后自动保存
- 支持回车键保存

### 3. 路径选择
- 选择新路径后立即保存

### 4. 线程数滑块
- 拖动滑块后 0.5 秒自动保存

---

## ⚙️ 高级设置

### 禁用自动保存（不推荐）

如果不想自动保存配置，可以注释掉相关代码：

```python
# 在 __init__ 方法中，注释掉这些行：
# self.date_entry.bind("<FocusOut>", lambda e: self.save_config())
# self.date_entry.bind("<Return>", lambda e: self.save_config())
```

### 手动保存配置

如果需要手动保存，可以：
1. 点击"开始下载"（会自动保存）
2. 直接关闭软件（会自动保存）

### 重置配置

如果想清除保存的配置：
1. 删除 `.era5_gui_config.json` 文件
2. 重新打开软件（恢复默认设置）

```bash
# Windows
del .era5_gui_config.json

# Linux/Mac
rm .era5_gui_config.json
```

---

## 🔍 配置文件详解

### 完整配置示例

```json
{
  "date": "202510",
  "local_root": "D:\\学习\\研一\\艾组\\ERA5数据",
  "thread_count": 8,
  "selected_vars": [
    "t",
    "u",
    "v",
    "w",
    "z",
    "q",
    "r"
  ]
}
```

### 字段说明

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `date` | string | 下载日期 (YYYYMM) | `"202510"` |
| `local_root` | string | 保存根目录路径 | `"D:/ERA5数据"` |
| `thread_count` | number | 并发线程数 (1-10) | `5` |
| `selected_vars` | array | 勾选的变量代码列表 | `["t", "u", "v"]` |

---

## 💡 使用技巧

### 技巧 1: 批量下载多个月份

```
1. 第一次：设置日期 202510，下载完成后关闭
2. 第二次：打开软件，修改日期为 202511，其他设置不变
3. 重复步骤 2，下载其他月份
```

### 技巧 2: 不同变量组合

```
1. 第一次：选择温度相关变量 (t, u, v, w)
2. 第二次：选择湿度变量 (q, r, cc)
3. 软件会记住每次的选择
```

### 技巧 3: 调试最佳线程数

```
1. 从 5 个线程开始
2. 观察下载速度
3. 逐步增加到 8、10
4. 找到最适合自己网络的线程数
5. 软件会记住这个设置
```

---

## ⚠️ 注意事项

### 1. 配置文件位置

- 配置文件必须与程序在同一目录
- 如果移动程序，记得一起移动配置文件

### 2. 路径格式

- Windows: 使用反斜杠 `\` 或正斜杠 `/`
- Linux/Mac: 使用正斜杠 `/`
- 软件会自动处理路径格式

### 3. 变量代码

- 必须使用有效的变量代码
- 无效代码会被忽略
- 有效的变量代码见 ERA5_VARS 字典

### 4. 配置文件损坏

如果配置文件损坏：
1. 软件会使用默认设置
2. 删除损坏的配置文件
3. 重新设置并保存

---

## 🐛 故障排除

### 问题 1: 配置没有保存

**可能原因**:
- 没有写入权限
- 磁盘已满

**解决方法**:
1. 检查程序目录是否有写入权限
2. 检查磁盘空间
3. 手动创建配置文件

---

### 问题 2: 配置没有加载

**可能原因**:
- 配置文件路径错误
- 配置文件格式错误

**解决方法**:
1. 确认 `.era5_gui_config.json` 在程序目录
2. 检查 JSON 格式是否正确
3. 查看控制台错误信息

---

### 问题 3: 百分比不更新

**可能原因**:
- UI 线程阻塞
- 下载速度太慢

**解决方法**:
1. 这是正常现象，每 0.1 秒更新一次
2. 如果长时间不更新，可能是网络问题
3. 查看速度监控面板

---

## 📊 完整功能列表

### v2.1 新功能
- ✅ 实时百分比显示
- ✅ 配置自动记忆
- ✅ 断点续传 (Range 请求)
- ✅ 自动重试机制
- ✅ 进度状态持久化

### 原有功能
- ✅ 多线程并发下载
- ✅ 变量筛选
- ✅ 速度监控
- ✅ 进度条显示
- ✅ 优雅停止

---

## 🔄 版本对比

| 功能 | v1.0 原版 | v2.0 断点续传 | v2.1 当前版 |
|------|----------|-------------|------------|
| 百分比显示 | ❌ | ❌ | ✅ |
| 配置记忆 | ❌ | ❌ | ✅ |
| 断点续传 | ❌ | ✅ | ✅ |
| 自动重试 | ❌ | ✅ | ✅ |
| 进度保存 | ❌ | ✅ | ✅ |
| 临时文件保留 | ❌ | ✅ | ✅ |

---

## 📞 技术支持

如有问题，请检查：
1. 控制台输出（错误信息）
2. 配置文件格式
3. 网络连接状态
4. 磁盘写入权限

---

**版本**: v2.1
**更新日期**: 2026-01-19
**主要特性**: 实时百分比 + 配置记忆
