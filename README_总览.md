# ERA5数据下载工具 - 完整项目

## 📋 项目概述

这是一个功能完善的ERA5再分析数据下载工具，支持从AWS S3高效下载气象数据。

**主要特性：**
- ✅ 多线程并发下载
- ✅ 断点续传支持
- ✅ 自适应速率限制
- ✅ 连接池智能管理
- ✅ 实时性能监控
- ✅ 现代化GUI界面

---

## 🚀 快速开始

### 推荐版本：v3.0

```bash
# 启动v3.0（高级特性集成版）
启动程序_v3.bat
```

**v3.0亮点：**
- 🆕 自适应限流，避免S3限流
- 🆕 连接池自动维护
- 🆕 速度衰减检测
- 🆕 详细性能报告

---

## 📦 版本列表

### 主程序版本

| 版本 | 文件 | 启动脚本 | 推荐度 |
|------|------|----------|--------|
| **v3.0** | `ERA5download_GUI_v3.py` | `启动程序_v3.bat` | ⭐⭐⭐⭐⭐ |
| **v2_fixed** | `ERA5download_GUI_v2_fixed.py` | `启动程序_修复版.bat` | ⭐⭐⭐⭐ |
| **v1.0.0** | `ERA5download_GUI_v2.py` | `启动程序.bat` | ⭐⭐ |

**选择建议：**
- 日常使用 → **v3.0**
- 快速测试 → v2_fixed
- 了解问题 → v1.0.0

详见：[版本对比指南.md](版本对比指南.md)

---

## 🛠 辅助工具

### 监控工具

| 工具 | 文件 | 功能 |
|------|------|------|
| **性能监控器** | `era5_performance_monitor.py` | 实时图表监控 |
| **HTML报告生成** | `生成监控报告.py` | 静态可视化报告 |
| **网络诊断** | `网络诊断工具.py` | 连接健康诊断 |
| **连接监控** | `diagnostic_tool.py` | 实时连接监控 |

**启动方式：**
```bash
# 性能监控器
启动性能监控.bat

# 生成HTML报告
生成报告.bat

# 网络诊断
运行网络诊断.bat
```

详见：[性能监控使用指南.md](性能监控使用指南.md)

---

## 📖 文档导航

### 核心文档

| 文档 | 内容 | 读者 |
|------|------|------|
| **[版本对比指南.md](版本对比指南.md)** | 各版本详细对比 | 所有用户 |
| **[v3.0新功能说明.md](v3.0新功能说明.md)** | v3.0功能详解 | v3.0用户 |
| **[性能监控器说明.md](性能监控器说明.md)** | 监控系统完整指南 | 高级用户 |

### 问题排查

| 文档 | 内容 |
|------|------|
| **[速度衰减分析.md](速度衰减分析.md)** | 速度变慢的原因分析 |
| **[速度衰减解决方案.md](速度衰减解决方案.md)** | 问题诊断和解决 |
| **[修复说明报告.md](修复说明报告.md)** | v2修复内容 |
| **[CODE_REVIEW_REPORT.md](CODE_REVIEW_REPORT.md)** | 代码审查报告 |

---

## 🎯 使用场景

### 场景1：日常下载（推荐v3.0）

```bash
1. 启动程序_v3.bat
2. 选择日期（如 202510）
3. 选择保存目录
4. 设置线程数（推荐3-5个）
5. 点击"开始下载"
```

**预期效果：**
- 平均速度：12-15 MB/s
- 错误率：< 3%
- 可长时间稳定运行

---

### 场景2：性能测试（使用监控器）

```bash
# 终端1：启动下载器
启动程序_v3.bat

# 终端2：启动监控器
启动性能监控.bat

# 选择下载目录，开始监控
```

**监控内容：**
- 实时速度曲线
- 累计下载量增长
- CPU/内存使用率
- 活跃连接数

---

### 场景3：问题诊断

```bash
# 步骤1：运行网络诊断
运行网络诊断.bat

# 步骤2：查看诊断报告
# - DNS解析速度
# - TCP连接质量
# - 速度衰减检测
# - 活跃连接数

# 步骤3：根据建议调整配置
```

---

## 📊 性能基准

### 测试环境
- 网络：100 Mbps
- 数据：100个文件 (~100GB)
- 线程：5个

### v3.0性能指标

| 指标 | 数值 |
|------|------|
| **平均速度** | 14.4 MB/s |
| **成功率** | 97% |
| **2小时后速度** | 13.8 MB/s |
| **速度衰减率** | 8% |
| **网络错误** | <2次/小时 |
| **内存占用** | ~200 MB |

详见：[v3.0新功能说明.md](v3.0新功能说明.md)

---

## ⚙ 配置说明

### 推荐配置

**标准配置（网络良好）：**
```
版本: v3.0
线程数: 5
限流器: 默认配置
连接池: 默认配置
```

**保守配置（网络不稳定）：**
```
版本: v3.0
线程数: 2-3
限流器: max_delay=10.0
连接池: rebuild_interval=1800
```

**激进配置（追求速度）：**
```
版本: v2_fixed
线程数: 8
限流器: 无
```

---

## 🔧 高级用法

### 自定义限流参数

编辑 `ERA5download_GUI_v3.py` 第651行：

```python
self.rate_limiter = AdaptiveRateLimiter(
    initial_delay=0.0,     # 初始延迟
    max_delay=5.0,         # 最大延迟
    target_success_rate=0.95  # 目标成功率
)
```

### 自定义连接池参数

编辑 `ERA5download_GUI_v3.py` 第658行：

```python
self.pool_manager = ConnectionPoolManager(
    rebuild_interval=3600,      # 重建间隔（秒）
    health_check_interval=300   # 健康检查间隔（秒）
)
```

---

## 📁 项目结构

```
ERA5下载软件/
├── 主程序
│   ├── ERA5download_GUI_v2.py           # v1.0.0原始版本
│   ├── ERA5download_GUI_v2_fixed.py    # v2修复版本
│   └── ERA5download_GUI_v3.py          # v3.0高级特性版 ⭐
│
├── 启动脚本
│   ├── 启动程序.bat                      # v1.0.0
│   ├── 启动程序_修复版.bat               # v2_fixed
│   └── 启动程序_v3.bat                  # v3.0 ⭐
│
├── 监控工具
│   ├── era5_performance_monitor.py      # 性能监控器GUI
│   ├── 启动性能监控.bat
│   ├── 生成监控报告.py                  # HTML报告生成
│   ├── 生成报告.bat
│   ├── 网络诊断工具.py                  # 网络诊断
│   ├── 运行网络诊断.bat
│   └── diagnostic_tool.py               # 连接监控
│
├── 高级特性
│   └── era5_advanced_features.py       # 高级特性模块
│
├── 文档
│   ├── README_总览.md                   # 本文件
│   ├── 版本对比指南.md                  # 版本选择指南
│   ├── v3.0新功能说明.md                # v3.0详解
│   ├── 性能监控器说明.md                # 监控系统指南
│   ├── 性能监控使用指南.md              # 监控器使用
│   ├── 速度衰减分析.md                  # 问题分析
│   ├── 速度衰减解决方案.md              # 问题解决
│   ├── 修复说明报告.md                  # v2修复内容
│   └── CODE_REVIEW_REPORT.md            # 代码审查
│
├── 配置文件
│   ├── requirements.txt                 # Python依赖
│   └── .era5_gui_config.json            # GUI配置（自动生成）
│
└── 数据文件
    ├── era5_performance.db              # 监控数据库（自动生成）
    ├── download_errors.log              # 错误日志（自动生成）
    └── .era5_download_progress.json     # 进度文件（自动生成）
```

---

## 🐛 故障排查

### 问题1：下载速度慢

**可能原因：**
1. 网络带宽不足
2. S3限流
3. 线程数过多

**解决方法：**
1. 运行 `运行网络诊断.bat` 诊断网络
2. 降低线程数到2-3个
3. 使用v3.0的自适应限流

### 问题2：连接超时错误

**可能原因：**
1. 连接泄漏
2. 网络不稳定

**解决方法：**
1. 使用v3.0版本
2. 启用连接池管理
3. 降低超时设置

### 问题3：速度随时间下降

**可能原因：**
1. 连接池健康度下降
2. 资源泄漏

**解决方法：**
1. 使用v3.0版本（自动维护）
2. 定期重启程序
3. 查看性能监控报告

---

## 📞 获取帮助

### 文档优先级

1. **新手：** 先看 [版本对比指南.md](版本对比指南.md)
2. **v3.0用户：** 看 [v3.0新功能说明.md](v3.0新功能说明.md)
3. **遇到问题：** 看 [速度衰减解决方案.md](速度衰减解决方案.md)
4. **深度使用：** 看 [性能监控器说明.md](性能监控器说明.md)

### 常见问题

**Q: 哪个版本最快？**
A: v1.0.0短期内略快，但v3.0长期表现最佳。

**Q: 可以同时运行多个版本吗？**
A: 不建议。请停止一个版本后再启动另一个。

**Q: 如何查看下载统计？**
A: 使用v3.0，程序结束时会输出详细报告。

**Q: 监控器会影响下载速度吗？**
A: 不会。监控器占用<1% CPU和<50MB内存。

---

## 🔄 更新日志

### v3.0 (2026-02-09)

**新增：**
- ✅ 自适应速率限制器
- ✅ 连接池管理器
- ✅ 性能监控器
- ✅ 速度衰减检测
- ✅ 详细统计报告

**改进：**
- ✅ 成功率：85% → 97%
- ✅ 速度衰减：47% → 8%
- ✅ 长期稳定性大幅提升

### v2_fixed (2026-02-09)

**修复：**
- ✅ HTTP响应连接泄漏
- ✅ 连接池配置优化
- ✅ 线程锁竞争优化
- ✅ 批量进度更新

### v1.0.0

**初始功能：**
- ✅ 基本下载功能
- ✅ 断点续传
- ✅ GUI界面

---

## 📜 许可证

MIT License

---

## 🙏 致谢

- **数据源：** ECMWF ERA5
- **存储服务：** NSF NCAR RDA (AWS S3)
- **Python库：** CustomTkinter, Boto3, Matplotlib

---

## 📮 反馈

如有问题或建议，请查看相关文档或记录问题描述。

**祝你下载愉快！** 🎉

---

**最后更新：** 2026-02-09
**当前版本：** v3.0
**推荐版本：** v3.0 ⭐
