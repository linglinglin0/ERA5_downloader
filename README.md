# ERA5 数据下载工具

一个基于 Python 和 CustomTkinter 的图形化 ERA5 再分析数据下载客户端，支持从 NCAR AWS S3 存储桶批量下载气象数据。

## 📋 版本信息

**当前版本**: v2.1
**发布日期**: 2026-01-19
**适用系统**: Windows / Linux / macOS

## ✨ 核心功能

### v2.1 新特性
- ✅ **断点续传**: 网络中断后可从断点位置继续下载，节省时间
- ✅ **自动重试**: 网络错误时自动重试 3 次（指数退避策略）
- ✅ **配置记忆**: 自动记住日期、路径、变量选择等设置
- ✅ **实时百分比**: 显示详细的文字百分比进度（如 "50%" 而非 "下载中"）

### 基础功能
- 变量筛选：支持按类别选择动力/热力学、湿度/云物理、化学成分等变量
- 多线程下载：可配置 1-10 个并发线程，实时监控下载速度
- 智能续传：自动检测本地文件完整性，跳过已下载文件
- 优雅停止：支持中断下载并**保留**临时文件供续传
- 实时监控：显示每线程下载进度、速度统计和系统日志

## 🚀 快速开始

### 环境要求

- Python >= 3.8
- 网络连接（访问 AWS S3）

### 安装依赖

```bash
pip install -r requirements.txt
```

或手动安装：
```bash
pip install customtkinter boto3
```

### 运行应用

```bash
python src/ERA5download_GUI.py
```

## 📖 使用指南

### 基本操作

1. **设置日期**：输入目标年月（格式 `YYYYMM`，如 `202510`）
2. **选择目录**：点击"选择文件夹"设置数据保存根目录
3. **选择变量**：勾选需要下载的 ERA5 变量（不选则下载全部）
4. **配置线程**：拖动滑块设置并发线程数（1-10，推荐 5）
5. **开始下载**：点击"开始下载"按钮，监控实时进度
6. **停止/关闭**：点击"停止并关闭"会**保留**临时文件供下次续传

### 配置自动记忆

关闭软件后，以下设置会自动保存：
- ✅ 日期
- ✅ 保存根目录路径
- ✅ 并发线程数
- ✅ 勾选的变量列表

下次打开软件时，这些设置会自动恢复。

### 断点续传使用

**场景 1: 网络中断**
- 程序会自动重试 3 次
- 每次重试间隔：2秒 → 4秒 → 8秒（指数退避）
- 重试成功后从断点继续下载

**场景 2: 手动停止**
- 点击"停止并关闭"
- 临时文件（`.tmp`）会被保留
- 下次启动时自动继续下载

**场景 3: 程序崩溃**
- 重新打开程序
- 选择相同的日期和路径
- 点击"开始下载"
- 已完成的文件会自动跳过，未完成的会继续下载

## 📊 进度显示说明

### 监控面板状态

| 显示内容 | 说明 |
|---------|------|
| `开始下载...` | 准备开始下载 |
| `50%` | 实时下载进度 ✨ |
| `50% (重试1)` | 下载进度 + 重试次数 ✨ |
| `断点续传 60.5MB` | 从 60.5MB 处继续下载 ✨ |
| `网络错误,4秒后重试(2/3)` | 等待重试 ✨ |
| `已存在(跳过)` | 文件已完整，跳过 |
| `完成` | 文件下载完成 |

### 系统日志示例
```
正在扫描... 目标变量: ['t', 'u', 'v']
共 120 个文件,已完成 50,剩余 70
当前速度: 5.23 MB/s
```

## 📦 变量列表

### 动力与热力学
- `t`: 空气温度 (K)
- `u`: U风分量 (m/s)
- `v`: V风分量 (m/s)
- `w`: 垂直速度 (Pa/s)
- `z`: 位势
- `d`: 散度
- `vo`: 相对涡度
- `pv`: 位涡

### 湿度与云物理
- `q`: 比湿
- `r`: 相对湿度
- `cc`: 云量
- `ciwc`: 云冰含量
- `clwc`: 云液水含量
- `crwc`: 雨水含量
- `cswc`: 雪水含量

### 化学成分
- `o3`: 臭氧

## 🌐 数据源

- **存储桶**: `nsf-ncar-era5` (NCAR AWS S3)
- **数据路径**: `e5.oper.an.pl/{YYYYMM}/`
- **访问方式**: 公开访问（无需 AWS 凭证）
- **数据范围**: 1940 年至今

## ⚙️ 高级配置

### 调整重试参数

编辑 `ERA5download_GUI_v2.py` 第 60-62 行：

```python
self.max_retries = 3          # 最大重试次数（默认3次）
self.retry_delay = 2          # 初始重试延迟，秒（默认2秒）
self.chunk_size = 8 * 1024 * 1024  # 分块大小，字节（默认8MB）
```

**网络不稳定时**建议：
```python
self.max_retries = 5  # 增加重试次数
self.retry_delay = 3  # 增加延迟
```

### 配置文件位置

- **用户配置**: `.era5_gui_config.json`（保存用户设置）
- **下载进度**: `.era5_download_progress.json`（保存下载进度）

这两个文件会在运行时自动生成。

## ⚠️ 注意事项

1. **临时文件**: 不要手动删除 `.tmp` 文件，它们用于断点续传
2. **网络稳定性**: 建议使用稳定网络，避免频繁中断
3. **磁盘空间**: 确保有足够空间存储下载数据
4. **线程数量**: 根据网络状况调整，推荐 5-8 个线程
5. **数据量**: 建议单次下载不超过 3 个月的数据

## ❓ 常见问题

### Q: 下载速度很慢怎么办？
- 增加并发线程数（推荐 8-10）
- 检查网络带宽和延迟
- 避免在高峰时段下载

### Q: 如何验证下载文件完整性？
- 程序通过文件大小校验（本地大小 = 远程大小）
- 不完整的文件会自动重新下载

### Q: 杀毒软件报警怎么办？
- 如果是PyInstaller打包的exe，可能是误报
- 可以添加到信任列表

### Q: 支持下载哪些时间段的数据？
- 支持从 1940 年至今的 ERA5 数据
- 只需修改日期输入框（格式 `YYYYMM`）

### Q: 程序崩溃后如何恢复？
- 重新打开程序
- 选择相同的日期和路径
- 点击"开始下载"，会自动跳过已完成的文件

### Q: 如何清除保存的配置？
- 删除 `.era5_gui_config.json` 文件
- 重启程序即可恢复默认设置

## 📚 相关文档

### 用户文档
- [快速开始指南](docs/user/快速开始.md) - 快速上手使用
- [断点续传使用指南](docs/user/断点续传使用指南.md) - 快速上手断点续传
- [新功能使用说明](docs/user/新功能使用说明.md) - 详细了解新功能
- [API文档](docs/user/API文档.md) - API接口说明

### 开发文档
- [性能改进实施总结](docs/dev/性能改进实施总结.md) - 性能优化记录
- [性能问题分析与改进方案](docs/dev/性能问题分析与改进方案.md) - 性能问题分析
- [Bug修复总结](docs/dev/Bug修复总结.md) - 已修复的问题
- [打包和分发指南](docs/dev/打包和分发指南.md) - 如何打包和分享程序
- [断点续传功能说明](docs/dev/断点续传功能说明.md) - 深入了解断点续传技术

### 技术报告
- [下载不完整问题分析报告](docs/reports/下载不完整问题分析报告.md) - 问题分析报告
- [文件打包清单](docs/reports/文件打包清单.md) - 分发包文件清单

## 🔗 相关资源

- [ERA5 官方文档](https://www.ecmwf.int/en/forecasts/datasets/reanalysis-datasets/era5)
- [NCAR AWS S3 访问](https://data.nccs.nasa.gov/thornes/ERA5/)
- [CustomTkinter 文档](https://customtkinter.tomschimansky.com/)
- [Boto3 S3 文档](https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html)

## 📄 许可证

本项目供学习和研究使用，可自由分发和修改。

## 🤝 贡献

欢迎提交问题和改进建议！

---

**版本**: v2.1
**更新**: 2026-01-19
**作者**: ERA5下载器开发组
