# ERA5下载性能监控系统 - 完整指南

## 系统概述

这是一套完整的ERA5下载性能监控解决方案，包含：

1. **实时监控GUI** - 图形化实时监控界面
2. **数据库持久化** - SQLite历史数据存储
3. **HTML报告生成** - 静态可视化报告
4. **网络诊断工具** - 连接健康检测
5. **高级特性模块** - 自适应限流和连接管理

---

## 快速开始

### 安装依赖

```bash
# 安装新增的监控依赖
uv add matplotlib psutil
```

### 启动监控器

```bash
# 方式1: 使用批处理脚本
启动性能监控.bat

# 方式2: 命令行启动
uv run era5_performance_monitor.py
```

### 生成报告

```bash
# 方式1: 使用批处理脚本
生成报告.bat

# 方式2: 命令行启动
uv run 生成监控报告.py
```

---

## 监控器功能详解

### 实时监控界面

**主界面布局：**
```
┌─────────────┬──────────────────────────────────────┐
│  控制面板    │  图表显示区                           │
│             │  ┌─────────────────────────────────┐ │
│ - 下载目录   │  │ Tab 1: 下载速度                │ │
│ - 更新间隔   │  │ Tab 2: 累计下载量              │ │
│ - 时间范围   │  │ Tab 3: 系统资源                │ │
│ - 控制按钮   │  │ Tab 4: 统计分析                │ │
│             │  └─────────────────────────────────┘ │
│ - 实时统计   │                                       │
│             │                                       │
└─────────────┴──────────────────────────────────────┘
```

**实时统计面板显示：**
- 当前速度（MB/s）
- 已下载量（GB）
- 运行时间（时:分:秒）
- 网络错误数

### 图表说明

#### 1. 下载速度图（蓝色曲线）
```
Y轴: 速度 (MB/s)
X轴: 时间 (时:分:秒)

用途:
- 检测速度衰减
- 发现网络问题
- 验证优化效果
```

#### 2. 累计下载量图（绿色曲线）
```
Y轴: 下载量 (GB)
X轴: 时间 (时:分:秒)

用途:
- 查看总体进度
- 计算剩余时间
- 验证下载完整性
```

#### 3. 系统资源图
```
Y轴: 使用率 (%)
X轴: 时间 (时:分:秒)

红色: CPU使用率
黄色: 内存使用率
青色: 活跃S3连接数

用途:
- 检测资源瓶颈
- 发现连接泄漏
- 优化线程配置
```

---

## 数据管理

### 数据库结构

```
era5_performance.db
└── performance_logs
    ├── id (主键)
    ├── timestamp (Unix时间戳)
    ├── datetime (格式化时间)
    ├── download_speed (下载速度)
    ├── total_downloaded (累计下载)
    ├── active_threads (活跃连接)
    ├── cpu_usage (CPU使用率)
    ├── memory_usage (内存使用率)
    └── network_errors (网络错误)
```

### 数据查询示例

**查询最近10条记录：**
```sql
SELECT * FROM performance_logs
ORDER BY timestamp DESC
LIMIT 10;
```

**计算平均速度：**
```sql
SELECT AVG(download_speed) / 1048576 as avg_speed_mbps
FROM performance_logs;
```

**每小时统计：**
```sql
SELECT
    strftime('%Y-%m-%d %H:00:00', datetime) as hour,
    AVG(download_speed) / 1048576 as avg_speed,
    MAX(download_speed) / 1048576 as max_speed,
    MIN(download_speed) / 1048576 as min_speed
FROM performance_logs
GROUP BY hour
ORDER BY hour;
```

### 数据导出

**CSV格式：**
- 点击"导出数据"按钮
- 选择保存位置
- 用Excel打开分析

**包含字段：**
- 时间（格式化）
- 时间戳（Unix）
- 下载速度（MB/s）
- 累计下载（GB）
- 活跃连接
- CPU使用率
- 内存使用率
- 网络错误数

---

## HTML报告

### 报告内容

**统计卡片：**
- 数据点数
- 平均速度
- 最高/最低速度
- 总下载量
- 平均CPU/内存
- 网络错误总数

**交互式图表：**
- 下载速度趋势（可缩放）
- 累计下载量增长
- 系统资源使用情况

**特性：**
- 完全离线查看
- 支持浏览器交互
- 响应式设计
- 美观的渐变界面

### 报告生成

```bash
# 自动生成并打开
生成报告.bat

# 报告文件名
era5_performance_report_YYYYMMDD_HHMMSS.html
```

---

## 使用场景

### 场景1: 性能对比测试

**目的：** 对比优化前后的性能

**步骤：**
1. 使用原版程序下载30分钟
2. 停止并导出数据
3. 使用优化版程序下载30分钟
4. 停止并导出数据
5. 对比两个报告

**对比指标：**
- 平均速度
- 速度波动（标准差）
- 网络错误数
- 资源使用率

### 场景2: 长期稳定性测试

**目的：** 测试长时间运行的稳定性

**步骤：**
1. 启动监控器
2. 设置时间范围为"全部"
3. 运行下载程序数小时
4. 观察速度衰减趋势

**分析要点：**
- 速度是否随时间下降
- 连接数是否持续增长
- 是否有内存泄漏

### 场景3: 网络诊断

**目的：** 诊断速度慢的原因

**步骤：**
1. 启动监控器和诊断工具
2. 观察各项指标
3. 定位问题根源

**诊断流程：**
```
速度慢
  ├─ CPU高 → 计算密集，优化算法
  ├─ 内存高 → 内存泄漏，检查代码
  ├─ 连接数多 → 连接泄漏，使用修复版
  └─ 网络错误多 → ISP限流或S3限流
```

### 场景4: 参数调优

**目的：** 找到最佳线程数

**方法：**
1. 测试不同线程数（1, 2, 3, 5, 10）
2. 每个配置运行30分钟
3. 对比平均速度和错误率
4. 选择最优配置

**优化目标：**
- 速度最快
- 错误最少
- 资源占用合理

---

## 性能指标解读

### 速度评估

| 速度范围 | 评级 | 说明 |
|---------|------|------|
| > 20 MB/s | ⭐⭐⭐⭐⭐ | 优秀，网络极佳 |
| 15-20 MB/s | ⭐⭐⭐⭐ | 良好，正常高速 |
| 10-15 MB/s | ⭐⭐⭐ | 一般，标准速度 |
| 5-10 MB/s | ⭐⭐ | 较慢，有问题 |
| < 5 MB/s | ⭐ | 很慢，需要检查 |

### 稳定性评估

| 指标 | 稳定 | 一般 | 不稳定 |
|------|------|------|--------|
| 速度标准差 | < 2 | 2-5 | > 5 |
| 速度变异系数 | < 15% | 15-30% | > 30% |
| 衰减率 | < 10% | 10-30% | > 30% |

### 资源使用评估

| 指标 | 正常 | 警告 | 危险 |
|------|------|------|------|
| CPU | < 50% | 50-80% | > 80% |
| 内存 | < 60% | 60-85% | > 85% |
| 连接数 | 5-15 | 15-30 | > 30 |

---

## 故障排查

### 问题1：监控器显示速度为0

**可能原因：**
- 下载目录不正确
- 下载程序未运行
- 监控目录没有新文件

**解决方法：**
```bash
1. 检查下载目录路径是否正确
2. 确认下载程序正在运行
3. 检查目录权限
4. 等待几秒看是否更新
```

### 问题2：图表不更新

**可能原因：**
- 监控未启动
- 更新间隔过长
- 数据库锁定

**解决方法：**
```bash
1. 确认"开始监控"按钮已点击
2. 降低更新间隔（1-2秒）
3. 重启监控器
```

### 问题3：数据库错误

**错误信息：** `database is locked`

**解决方法：**
```bash
1. 关闭所有访问数据库的程序
2. 删除数据库锁文件
3. 重启监控器
```

---

## 最佳实践

### 1. 定期导出数据

```bash
# 每天导出一次数据
# 便于长期分析和存档
```

### 2. 设置合理的更新间隔

```python
# 实时监控：1-2秒
# 长期监控：5-10秒
```

### 3. 定期清理数据库

```bash
# 删除30天前的数据
sqlite3 era5_performance.db
DELETE FROM performance_logs
WHERE timestamp < $(date -d '30 days ago' +%s);
```

### 4. 备份重要数据

```bash
# 备份数据库
copy era5_performance.db backup_$(date +%Y%m%d).db
```

---

## 进阶使用

### Python数据分析

```python
import pandas as pd
import matplotlib.pyplot as plt

# 读取导出的CSV
df = pd.read_csv('era5_performance_20260209_123045.csv')

# 转换时间列
df['时间'] = pd.to_datetime(df['时间'])

# 绘制速度图
plt.figure(figsize=(12, 6))
plt.plot(df['时间'], df['下载速度(MB/s)'], label='速度')
plt.xlabel('时间')
plt.ylabel('速度 (MB/s)')
plt.title('下载速度趋势')
plt.legend()
plt.grid(True)
plt.show()

# 统计分析
print(f"平均速度: {df['下载速度(MB/s)'].mean():.2f} MB/s")
print(f"标准差: {df['下载速度(MB/s)'].std():.2f}")
print(f"变异系数: {df['下载速度(MB/s)'].std() / df['下载速度(MB/s)'].mean() * 100:.1f}%")
```

### 自动化监控

```python
# auto_monitor.py - 自动启动监控

import subprocess
import time
import os

# 启动下载程序
download_proc = subprocess.Popen(['python', 'ERA5download_GUI_v2_fixed.py'])

# 等待30秒
time.sleep(30)

# 启动监控器
monitor_proc = subprocess.Popen(['python', 'era5_performance_monitor.py'])

# 等待下载完成
download_proc.wait()

# 停止监控
monitor_proc.terminate()

# 生成报告
subprocess.run(['python', '生成监控报告.py'])
```

---

## 文件清单

### 监控相关
- `era5_performance_monitor.py` - 监控器主程序
- `启动性能监控.bat` - 监控器启动脚本
- `生成监控报告.py` - HTML报告生成器
- `生成报告.bat` - 报告生成启动脚本
- `性能监控使用指南.md` - 详细使用指南
- `era5_performance.db` - SQLite数据库（运行后生成）

### 诊断相关
- `网络诊断工具.py` - 网络诊断工具
- `运行网络诊断.bat` - 诊断工具启动脚本
- `diagnostic_tool.py` - 连接监控工具

### 高级特性
- `era5_advanced_features.py` - 高级特性模块
- `速度衰减解决方案.md` - 问题解决指南

---

## 版本信息

### 监控器 v1.0.0

**发布日期：** 2026-02-09

**主要功能：**
- ✅ 实时速度监控
- ✅ 累计下载量监控
- ✅ 系统资源监控
- ✅ SQLite数据持久化
- ✅ CSV数据导出
- ✅ HTML报告生成
- ✅ 统计分析

**依赖项：**
- customtkinter >= 5.0.0
- matplotlib >= 3.7.0
- psutil >= 5.9.0
- sqlite3 (Python内置)

---

## 总结

这套监控系统可以：
1. **实时可视化**下载性能
2. **历史数据分析**和对比
3. **问题诊断**和定位
4. **性能优化**验证
5. **自动化报告**生成

**建议工作流：**
```
开始下载 → 启动监控 → 观察图表 → 发现问题 → 诊断修复 → 验证效果
```

**祝你使用愉快！**

如有问题，请参考：
- `性能监控使用指南.md` - 详细使用说明
- `速度衰减解决方案.md` - 问题排查指南
- `诊断工具使用说明.md` - 网络诊断指南
